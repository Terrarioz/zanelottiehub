<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Orbitron:wght@500&display=swap');
        
        :root {
            --neon-pink: #ff2a6d;
            --neon-blue: #ff2a6d;
            --neon-purple: #d300c5;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* (Keep all your existing CSS styles exactly as they were) */
        /* ... All your beautiful CSS remains unchanged ... */
        
    </style>
</head>
<body>
    <!-- Greeting overlay -->
    <div class="greeting-container">
        <div class="greeting" id="time-greeting">Good Morning</div>
        <div class="username" id="username-display">User</div>
    </div>

    <!-- Main content -->
    <div class="container">
        <h1 style="font-family: 'Orbitron', sans-serif; color: var(--neon-blue); text-align: center;">Dashboard</h1>
        
        <div class="posts-container" id="posts-container">
            <!-- Posts will be dynamically added here -->
        </div>
    </div>

    <!-- Add post button -->
    <div class="add-post" id="add-post-btn"></div>

    <!-- Create post modal -->
    <div class="modal" id="post-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Create New Post</h2>
            <form id="post-form">
                <div class="form-group">
                    <label for="post-title">Title</label>
                    <input type="text" id="post-title" placeholder="Enter the title" required>
                </div>
                <div class="form-group">
                    <label for="post-content">Content</label>
                    <textarea id="post-content" placeholder="Write something..." required></textarea>
                </div>
                <button type="submit" class="submit-btn">Post</button>
            </form>
        </div>
    </div>

    <!-- View post modal -->
    <div class="modal" id="view-post-modal">
        <div class="post-view" id="post-view-content">
            <!-- Post content will be dynamically added here -->
        </div>
    </div>

    <!-- Floating hearts -->
    <script>
        // Create floating hearts (keep this animation script)
        function createHearts() {
            const heart = document.createElement('div');
            heart.className = 'heart';
            
            // Random position
            const startX = Math.random() * window.innerWidth;
            heart.style.left = startX + 'px';
            heart.style.animationDuration = (Math.random() * 4 + 3) + 's';
            
            document.body.appendChild(heart);
            
            // Remove heart after animation completes
            setTimeout(() => {
                heart.remove();
            }, 7000);
        }
        
        // Create initial batch of hearts
        for (let i = 0; i < 15; i++) {
            createHearts();
        }
        
        // Create hearts more frequently
        setInterval(createHearts, 300);
    </script>

    <!-- Firebase-integrated JavaScript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc, 
            updateDoc, 
            query, 
            orderBy,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYAtGRe2mYyzoU0iurYKX4rt-WP7yUTaY",
            authDomain: "zanelottiehub.firebaseapp.com",
            projectId: "zanelottiehub",
            storageBucket: "zanelottiehub.appspot.com",
            messagingSenderId: "1082631985410",
            appId: "1:1082631985410:web:cdde430c33660088554a1b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM elements
        const postsContainer = document.getElementById('posts-container');
        const postForm = document.getElementById('post-form');
        const viewPostModal = document.getElementById('view-post-modal');
        const postViewContent = document.getElementById('post-view-content');

        // Set username from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let username = urlParams.get('user') || localStorage.getItem('username') || 'User';
        document.getElementById('username-display').textContent = username;

        // Set time-based greeting
        const hour = new Date().getHours();
        const greeting = document.getElementById('time-greeting');
        if (hour < 12) {
            greeting.textContent = 'Good Morning';
        } else if (hour < 18) {
            greeting.textContent = 'Good Afternoon';
        } else {
            greeting.textContent = 'Good Evening';
        }

        // Firestore references
        const postsCol = collection(db, "posts");
        const postsQuery = query(postsCol, orderBy("createdAt", "desc"));

        // ---------- Real-time Posts Listener ----------
        const unsubscribePosts = onSnapshot(postsQuery, (snapshot) => {
            postsContainer.innerHTML = '';
            
            snapshot.forEach(docSnap => {
                const post = docSnap.data();
                post.id = docSnap.id;
                
                const postElement = document.createElement('div');
                postElement.className = 'post-card';
                postElement.innerHTML = `
                    <h3 class="post-title">${post.title}</h3>
                    <p class="post-preview">${post.content.split('\n')[0].substring(0, 100)}...</p>
                    <small>${formatDate(post.createdAt?.toDate())}</small>
                `;
                postElement.addEventListener('click', () => viewPost(post.id));
                postsContainer.appendChild(postElement);
            });
        });

        // ---------- Create New Post ----------
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;

            if (!title.trim() || !content.trim()) return;

            try {
                await addDoc(postsCol, {
                    title,
                    content,
                    author: username,
                    createdAt: serverTimestamp(),
                    replies: []
                });
                
                postForm.reset();
                document.getElementById('post-modal').style.display = 'none';
            } catch (error) {
                console.error("Error adding post: ", error);
            }
        });

        // ---------- View Post & Handle Replies ----------
        async function viewPost(postId) {
            const postDoc = doc(db, "posts", postId);
            
            // Real-time listener for this specific post
            const unsubscribePost = onSnapshot(postDoc, (docSnap) => {
                if (!docSnap.exists()) return;
                
                const post = docSnap.data();
                postViewContent.innerHTML = `
                    <h2>${post.title}</h2>
                    <p class="post-author">Posted by ${post.author} â€¢ ${formatDate(post.createdAt?.toDate())}</p>
                    <div class="post-content">${post.content.replace(/\n/g,'<br>')}</div>
                    
                    <div class="replies">
                        <h3>Replies (${post.replies?.length || 0})</h3>
                        ${(post.replies || []).map(reply => `
                            <div class="reply">
                                <div class="reply-author">${reply.author}</div>
                                <div class="reply-content">${reply.content.replace(/\n/g,'<br>')}</div>
                                <small>${formatDate(reply.createdAt?.toDate())}</small>
                            </div>
                        `).join('')}
                        
                        <div class="reply-form">
                            <textarea id="reply-content" placeholder="Write your reply..."></textarea>
                            <button class="reply-btn">Post Reply</button>
                        </div>
                    </div>
                `;

                // Handle reply submission
                postViewContent.querySelector('.reply-btn').onclick = async () => {
                    const replyContent = postViewContent.querySelector('#reply-content').value;
                    if (!replyContent.trim()) return;
                    
                    try {
                        await updateDoc(postDoc, {
                            replies: [...(post.replies || []), { 
                                author: username, 
                                content: replyContent, 
                                createdAt: serverTimestamp() 
                            }]
                        });
                        postViewContent.querySelector('#reply-content').value = '';
                    } catch (error) {
                        console.error("Error adding reply: ", error);
                    }
                };
            });

            // Store unsubscribe function to clean up later
            postViewContent._unsubscribe = unsubscribePost;
            viewPostModal.style.display = 'flex';
        }

        // Close modal cleanup
        document.querySelector('#view-post-modal .close-modal').addEventListener('click', () => {
            if (postViewContent._unsubscribe) {
                postViewContent._unsubscribe();
                delete postViewContent._unsubscribe;
            }
        });

        // Helper function to format dates
        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Make viewPost available globally
        window.viewPost = viewPost;

        // Modal controls (open/close)
        document.getElementById('add-post-btn').addEventListener('click', () => {
            document.getElementById('post-modal').style.display = 'flex';
        });

        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', () => {
                document.getElementById('post-modal').style.display = 'none';
                document.getElementById('view-post-modal').style.display = 'none';
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('post-modal')) {
                document.getElementById('post-modal').style.display = 'none';
            }
            if (event.target === document.getElementById('view-post-modal')) {
                document.getElementById('view-post-modal').style.display = 'none';
            }
        });
    </script>
</body>
</html>
