<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYAtGRe2mYyzoU0iurYKX4rt-WP7yUTaY",
  authDomain: "zanelottiehub.firebaseapp.com",
  projectId: "zanelottiehub",
  storageBucket: "zanelottiehub.firebasestorage.app",
  messagingSenderId: "1082631985410",
  appId: "1:1082631985410:web:cdde430c33660088554a1b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;

// ---------- Firestore helpers ----------
const postsCol = collection(db, "posts");
const postsQuery = query(postsCol, orderBy("createdAt", "desc"));

// ---------- Real-time listener ----------
onSnapshot(postsQuery, (snapshot) => {
  const postsContainer = document.getElementById('posts-container');
  postsContainer.innerHTML = '';
  snapshot.forEach(docSnap => {
    const post = docSnap.data();
    post.id = docSnap.id;

    const postElement = document.createElement('div');
    postElement.className = 'post-card';
    postElement.innerHTML = `
      <h3 class="post-title">${post.title}</h3>
      <p class="post-preview">${post.content.split('\n')[0].substring(0, 100)}...</p>
    `;
    postElement.addEventListener('click', () => viewPost(post.id));
    postsContainer.appendChild(postElement);
  });
});

// ---------- Add new post ----------
document.getElementById('post-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('post-title').value;
  const content = document.getElementById('post-content').value;
  const username = document.getElementById('username-display').textContent;

  if (!title.trim() || !content.trim()) return;

  await addDoc(postsCol, {
    title,
    content,
    author: username,
    createdAt: new Date(),
    replies: []
  });

  document.getElementById('post-form').reset();
  document.getElementById('post-modal').style.display = 'none';
});

// ---------- View and reply ----------
async function viewPost(postId) {
  const postDoc = doc(db, "posts", postId);
  const postSnap = await postDoc.get ? await postDoc.get() : null;

  const postView = document.getElementById('post-view-content');
  onSnapshot(postDoc, (snapshot) => {
    const post = snapshot.data();
    if (!post) return;
    postView.innerHTML = `
      <h2>${post.title}</h2>
      <p class="post-author">Posted by ${post.author}</p>
      <div class="post-content">${post.content.replace(/\n/g,'<br>')}</div>
      <div class="replies">
        <h3>Replies (${post.replies.length})</h3>
        ${post.replies.map(r => `
          <div class="reply">
            <div class="reply-author">${r.author}</div>
            <div class="reply-content">${r.content.replace(/\n/g,'<br>')}</div>
          </div>
        `).join('')}
        <div class="reply-form">
          <textarea id="reply-content" placeholder="Write your reply..."></textarea>
          <button class="reply-btn">Post Reply</button>
        </div>
      </div>
    `;

    const replyBtn = postView.querySelector('.reply-btn');
    replyBtn.onclick = async () => {
      const replyText = postView.querySelector('#reply-content').value;
      if (!replyText.trim()) return;
      const username = document.getElementById('username-display').textContent;

      await updateDoc(postDoc, {
        replies: [...post.replies, { author: username, content: replyText, createdAt: new Date() }]
      });

      postView.querySelector('#reply-content').value = '';
    };
  });

  document.getElementById('view-post-modal').style.display = 'flex';
}
window.viewPost = viewPost;
</script>
